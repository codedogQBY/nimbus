# Nimbus 多源聚合网盘 - 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品愿景
打造一个开源、安全、高效的**个人网盘解决方案**，通过聚合多个免费存储服务，为个人用户提供大容量、高可用的云存储体验。系统设计为**单用户多角色权限管理**模式，文件统一存储，通过RBAC权限系统实现细粒度的访问控制。

### 1.2 产品定位
- **目标用户**: 个人用户、开发者
- **核心价值**: 个人网盘、权限管理、免费、开源、多源聚合、隐私保护
- **差异化优势**: 插件式存储源扩展、智能分片存储、中间层隐私保护、灵活的RBAC权限系统
- **使用场景**: 个人文件管理、家庭共享、多设备同步、访客临时访问

## 2. 核心功能需求

### 2.1 用户认证与邮箱验证
**优先级: P0**

#### 功能描述
完整的用户认证系统，包括注册、登录、邮箱验证等功能。强制要求邮箱验证以确保用户身份真实性。

#### 核心功能
1. **用户注册**
   - 填写用户名、邮箱、密码
   - 发送邮箱验证码（6位数字）
   - 验证码有效期5分钟
   - 验证码输入正确后激活账号
   - 支持重新发送验证码（60秒冷却）

2. **用户登录**
   - 支持用户名登录
   - 支持邮箱登录
   - 登录时检查账号是否已激活
   - 未激活账号可重新发送验证码

3. **邮箱验证**
   - 注册时必须验证邮箱
   - 修改邮箱时需要验证新邮箱
   - 验证码通过邮件发送
   - 验证码格式：6位随机数字

4. **密码重置**
   - 通过邮箱重置密码
   - 发送重置验证码
   - 验证通过后设置新密码

#### 用户故事
- 作为新用户，我希望通过邮箱注册账号并验证我的邮箱地址
- 作为用户，我希望能用用户名或邮箱登录，更加灵活
- 作为用户，我希望忘记密码时能通过邮箱重置
- 作为管理员，我希望确保所有用户都是经过邮箱验证的真实用户

#### 验收标准
- [ ] 注册时强制邮箱验证
- [ ] 支持用户名和邮箱两种登录方式
- [ ] 验证码5分钟有效期
- [ ] 重发验证码有60秒冷却时间
- [ ] 未激活账号不能登录
- [ ] 支持密码重置功能
- [ ] 邮件发送失败有重试机制
- [ ] 验证码尝试次数限制（防暴力破解）

### 2.2 存储源管理
**优先级: P0**

#### 功能描述
支持多种存储源的插件式接入，包括但不限于：
- Cloudflare R2
- 七牛云存储
- Telegram Bot API
- GitHub Repository
- 其他 S3 兼容存储

#### 用户故事
- 作为用户，我希望能够配置多个存储源，提高存储容量和可用性
- 作为用户，我希望系统能够自动选择最优存储源，无需手动选择
- 作为开发者，我希望能够轻松扩展新的存储源插件

#### 验收标准
- [ ] 支持至少 4 种存储源
- [ ] 存储源配置界面友好
- [ ] 存储源状态实时监控
- [ ] 失效存储源自动切换

### 2.2 智能存储源分配与文件夹同步
**优先级: P0**

#### 功能描述
系统自动选择最优存储源进行文件上传，无需用户手动选择。同时在所有已配置的存储源中自动维护相同的文件夹结构，确保文件夹的跨源同步和统一视图。

#### 核心机制
1. **自动存储源选择**: 基于容量、速度、文件类型等因素智能选择上传目标
2. **文件夹结构同步**: 在所有存储源中自动创建和维护相同的目录树
3. **统一文件夹视图**: 读取时合并所有存储源的文件，呈现完整的文件夹内容
4. **跨源文件管理**: 支持文件在不同存储源间的透明访问和管理

#### 用户故事
- 作为用户，我希望上传文件时系统自动选择最佳存储源，无需我手动选择
- 作为用户，我希望创建文件夹时，系统自动在所有存储源中同步创建相同结构
- 作为用户，我希望查看文件夹时能看到所有存储源中的文件，就像在一个统一的存储空间
- 作为用户，我希望移动或重命名文件夹时，所有存储源都能保持同步
- 作为用户，我希望删除文件夹时，系统能智能处理不同存储源中的文件

#### 验收标准
- [ ] 文件上传时系统自动选择存储源，用户无需手动选择
- [ ] 文件夹操作（创建/重命名/移动/删除）自动同步到所有存储源
- [ ] 文件夹视图自动合并所有存储源的内容
- [ ] 支持存储源离线时的文件夹结构恢复
- [ ] 提供文件夹同步状态监控和错误处理

### 2.3 隐私保护中间层
**优先级: P0**

#### 功能描述
通过代理层隐藏真实存储源，防止用户通过抓包获取存储源信息。

#### 用户故事
- 作为用户，我希望分享文件时不暴露真实存储源
- 作为用户，我希望即使有人抓包也无法直接访问我的存储源
- 作为管理员，我希望能够控制访问权限和流量

#### 验收标准
- [ ] 所有文件访问通过代理层
- [ ] 支持访问令牌和时效控制
- [ ] 支持访问日志记录
- [ ] 支持访问频率限制

### 2.4 文件分享功能
**优先级: P1**

#### 功能描述
支持文件和文件夹的安全分享，包括密码保护、时效控制、访问次数限制。

#### 用户故事
- 作为用户，我希望能够生成安全的分享链接
- 作为用户，我希望能够设置分享密码和有效期
- 作为用户，我希望能够查看分享文件的访问统计

#### 验收标准
- [ ] 支持单文件和文件夹分享
- [ ] 支持密码保护和有效期设置
- [ ] 支持访问次数限制
- [ ] 分享链接访问统计

### 2.5 在线解压缩
**优先级: P1**

#### 功能描述
支持常见压缩格式的在线预览和解压，包括 ZIP、RAR、7Z、TAR 等。

#### 用户故事
- 作为用户，我希望能够在线预览压缩文件内容
- 作为用户，我希望能够选择性解压文件
- 作为用户，我希望解压过程有进度显示

#### 验收标准
- [ ] 支持 ZIP、RAR、7Z、TAR 格式
- [ ] 支持压缩文件预览
- [ ] 支持选择性解压
- [ ] 解压进度实时显示

### 2.6 权限管理系统 (RBAC)
**优先级: P0**

#### 功能描述
基于角色的访问控制系统，实现细粒度的权限管理。个人网盘模式下，所有文件统一存储不做用户隔离，但通过角色和权限控制不同访问级别。

#### 核心概念
- **角色 (Role)**: 预定义的权限集合（如：管理员、访客、只读用户、家庭成员等）
- **权限 (Permission)**: 具体的操作权限（如：文件上传、下载、删除、分享等）
- **用户 (User)**: 可分配多个角色，继承所有角色的权限
- **无用户隔离**: 所有文件在同一存储空间，通过权限控制访问

#### 预设角色
1. **Owner (所有者)**: 拥有所有权限，唯一角色
2. **Admin (管理员)**: 管理文件、配置存储源、管理其他用户
3. **Editor (编辑者)**: 上传、编辑、删除文件
4. **Viewer (查看者)**: 只读访问，可下载
5. **Guest (访客)**: 临时访问指定文件或文件夹

#### 权限列表
- `files.upload` - 上传文件
- `files.download` - 下载文件
- `files.delete` - 删除文件
- `files.rename` - 重命名文件
- `files.move` - 移动文件
- `files.share` - 分享文件
- `folders.create` - 创建文件夹
- `folders.delete` - 删除文件夹
- `storage.view` - 查看存储源信息
- `storage.manage` - 管理存储源配置
- `users.view` - 查看用户列表
- `users.manage` - 管理用户角色
- `settings.view` - 查看系统设置
- `settings.manage` - 修改系统设置

#### 用户故事
- 作为所有者，我希望能创建不同角色的用户账号，便于家庭成员共享使用
- 作为管理员，我希望能管理文件和存储源，但不能修改系统设置
- 作为访客用户，我希望能临时访问指定的文件，但不能看到其他内容
- 作为只读用户，我希望能浏览和下载文件，但不能修改或删除

#### 验收标准
- [ ] 支持角色的创建、编辑、删除
- [ ] 支持权限的灵活分配
- [ ] 支持用户分配多个角色
- [ ] 每个操作都有权限检查
- [ ] 提供权限审计日志
- [ ] 支持权限继承和优先级

### 2.7 文件管理
**优先级: P1**

#### 功能描述
完整的文件管理功能，包括上传、下载、重命名、删除、移动、复制等。所有操作受权限系统控制。

#### 用户故事
- 作为用户，我希望能够像使用本地文件管理器一样管理云端文件
- 作为用户，我希望能够批量操作文件
- 作为用户，我希望能够搜索文件
- 作为用户，我的操作会根据权限进行限制

#### 验收标准
- [ ] 支持拖拽上传
- [ ] 支持文件夹上传
- [ ] 支持批量操作
- [ ] 支持文件搜索
- [ ] 支持文件预览
- [ ] 所有操作遵循权限控制

## 3. 技术需求

### 3.1 性能要求
- 文件上传/下载速度 > 1MB/s
- 文件列表加载时间 < 2s
- 分片文件合并时间 < 5s
- 支持并发用户数 > 100

### 3.2 安全要求
- 所有 API 接口需要认证
- 敏感数据加密存储
- 支持 HTTPS 传输
- 定期安全审计

### 3.3 可用性要求
- 系统可用性 > 99%
- 存储源故障自动切换
- 数据备份和恢复机制
- 错误监控和告警

## 4. 产品路线图

### Phase 1 (MVP - 2个月)
- [ ] 基础文件管理功能
- [ ] 2-3个存储源插件
- [ ] 简单的分片存储
- [ ] 基础的文件分享

### Phase 2 (完整版 - 4个月)
- [ ] 完整的存储源插件系统
- [ ] 智能分片算法优化
- [ ] 隐私保护中间层
- [ ] 在线解压缩功能

### Phase 3 (增强版 - 6个月)
- [ ] 高级分享功能
- [ ] 文件版本管理
- [ ] 团队协作功能
- [ ] 移动端适配

## 5. 风险评估

### 5.1 技术风险
- **存储源 API 变更**: 建立抽象层，降低耦合度
- **大文件处理性能**: 优化分片算法和并发处理
- **跨源数据一致性**: 实现分布式事务机制

### 5.2 运营风险
- **存储源政策变化**: 支持多存储源，分散风险
- **流量成本控制**: 实现智能缓存和 CDN 策略
- **用户数据安全**: 建立完善的安全机制

## 6. 成功指标

### 6.1 产品指标
- 月活跃用户数 > 1000
- 用户存储数据量 > 10TB
- 文件分享使用率 > 60%
- 用户满意度 > 4.5/5

### 6.2 技术指标
- API 响应时间 < 500ms
- 文件上传成功率 > 99%
- 系统故障恢复时间 < 10min
- 存储源切换成功率 > 95%